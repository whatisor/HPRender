KHPRender=function(a){var b=document.createElement("canvas"),c=b.getContext("webgl")||b.getContext("experimental-webgl"),d=c.getParameter(c.MAX_TEXTURE_SIZE);console.log("Maximum texture size "+d),this.maxSize=d,this.rowH=128,this.symbolW=46464/135,this.rowSpace=20,this.header=30,this.meshPositions=[],this.meshUVs=[],this.textures=[],this.uv=[0,0],this.uvBox=[0,0],this.boxs={},this.init(),this.animate()},KHPRender.prototype.constructor=KHPRender,KHPRender.prototype.createBank=function(a){var b=document.createElement("canvas");b.style.backgroundColor="transparent",b.width=this.maxSize,b.height=1024*a*1024/4/this.maxSize;var c=b.getContext("2d");c.fillStyle="rgba(0,0,0,0)",c.fillRect(0,0,b.width,b.height);var d=new THREE.CanvasTexture(b),e={position:[],uv:[],texture:d,canvas:b,context:c};return e},KHPRender.prototype.createContext=function(){var a,b,c,d,h;d=new THREE.WebGLRenderer({alpha:!0,antialias:!0,sortObjects:!0}),d.setSize(window.innerWidth,window.innerHeight),a=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,1,1e4);var j=a.fov*(Math.PI/180);a.position.z=window.innerHeight/(2*Math.tan(j/2));new THREE.PointLight(16777215),new THREE.AmbientLight(10066329);b=new THREE.TrackballControls(a),b.zoomSpeed=.02,b.noZoom=!1,b.noPan=!1,b.noRotate=!0,b.keys=[65,83,68],c=new THREE.Scene,document.body.appendChild(d.domElement),h=new Stats,h.domElement.style.position="absolute",h.domElement.style.top="0px",document.body.appendChild(h.domElement),this.controls=b,this.renderer=d,this.scene=c,this.camera=a,this.stats=h},KHPRender.prototype.init=function(){var a=this.createBank(32);this.boxPosition=a.position,this.boxUV=a.uv,this.canvasTextureBox=a.canvas,this.contextBox=a.context,this.textureBox=a.texture;var b=this.createBank(256);this.textures.push(b.texture),this.meshPositions.push(b.position),this.meshUVs.push(b.uv),this.textPosition=b.position,this.textUV=b.uv,this.canvasTexture=b.canvas,this.context=b.context,console.log("No of Banks "+this.textures.length),this.createContext()},KHPRender.prototype.animate=function(){requestAnimationFrame(this.animate.bind(this)),this.controls.update(),this.render()},KHPRender.prototype.render=function(){this.locos&&this.update(),this.stats.update(),this.renderer.render(this.scene,this.camera)},KHPRender.prototype.addSymbol=function(a,b){var c=this.rowH,d=this.symbolW,e=this.rowSpace,f=this.drawSymbolLabels(a),g=a.x-window.innerWidth/2,h=-(c+e)*b+window.innerHeight/2,i={position:{x:g,y:h,z:0},uv:f.box,size:[d,c]};this.addGeometry(i,this.boxPosition,this.boxUV);var j=5,k=5,l=this.canvasTexture.width,m=this.canvasTexture.height;this.addGeometry({position:{x:g+d/2-f.status[2]*l/2+j,y:h-j,z:k},uv:f.status,size:[f.status[2]*l,f.status[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+j,y:h-j,z:k},uv:f.departLoc,size:[f.departLoc[2]*l,f.departLoc[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+d-f.arrivalLoc[2]*l-j,y:h-j,z:k},uv:f.arrivalLoc,size:[f.arrivalLoc[2]*l,f.arrivalLoc[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+j,y:h-this.header-j,z:k},uv:f.scheDepartTime,size:[f.scheDepartTime[2]*l,f.scheDepartTime[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+d-f.scheArrivalTime[2]*l-j,y:h-this.header-j,z:k},uv:f.scheArrivalTime,size:[f.scheArrivalTime[2]*l,f.scheArrivalTime[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+j,y:h-c+f.actualDepartTime[3]*m+j,z:k},uv:f.actualDepartTime,size:[f.actualDepartTime[2]*l,f.actualDepartTime[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+d-f.actualArrivalTime[2]*l-j,y:h-c+f.actualArrivalTime[3]*m+j,z:k},uv:f.actualArrivalTime,size:[f.actualArrivalTime[2]*l,f.actualArrivalTime[3]*m]},this.textPosition,this.textUV),this.addGeometry({position:{x:g+d/2-f.trainID[2]*l/2+j,y:h-c/2+f.trainID[3]*m-this.header,z:k},uv:f.trainID,size:[f.trainID[2]*l,f.trainID[3]*m]},this.textPosition,this.textUV)},KHPRender.prototype.addTimeBox=function(a,b){var c=this.rowH,e=(this.symbolW,this.rowSpace),f=this.drawBoxLabels(a),g=a.x-window.innerWidth/2,h=-(c+e)*b+window.innerHeight/2,i=this.canvasTexture.width,j=this.canvasTexture.height,k={position:{x:g,y:h,z:0},uv:f.box,size:[a.width,c]};this.addGeometry(k,this.boxPosition,this.boxUV),this.addGeometry({position:{x:g+a.width/2-f.label[2]*i/2,y:h-c/2+f.label[3]*j-this.header,z:5},uv:f.label,size:[f.label[2]*i,f.label[3]*j]},this.textPosition,this.textUV)},KHPRender.prototype.getUV=function(a,b){var d=this.uv.slice();if(d[0]<this.canvasTexture.width-a);else if(d[1]+b<this.canvasTexture.height-b)d[0]=0,d[1]+=b;else{this.uv=[0,0];var e=this.createBank(256);this.textPosition=e.position,this.textUV=e.uv,this.textures.push(e.texture),this.meshPositions.push(e.position),this.meshUVs.push(e.uv),this.canvasTexture=e.canvas,this.context=e.context,d=[this.uv[0],this.uv[1]],console.log("No of Banks "+this.textures.length)}return d},KHPRender.prototype.getUVBox=function(a,b,c){var d=this.uvBox.slice();return d},KHPRender.prototype.updateUV=function(a,b,c){this.uv[0]=a[0]+b,this.uv[1]=a[1]},KHPRender.prototype.updateUVBox=function(a,b,c){this.uvBox[0]=a[0]+b,this.uvBox[1]=a[1]},KHPRender.prototype.drawBox=function(a){if(this.boxs[a.color+""+Math.floor(a.w)])return this.boxs[a.color+""+Math.floor(a.w)];var b=a.w,c=a.h,d=a.header,e=this.contextBox,f=this.getUVBox(b,c,!0);e.strokeStyle=a.strokeColor,e.strokeRect(f[0],f[1],b,c),e.fillStyle=a.fillColor,e.fillRect(f[0],f[1],b,d),e.strokeRect(f[0],f[1],b,d),this.updateUVBox(f,b+2);var g=this.canvasTextureBox.width,h=this.canvasTextureBox.height,i=[f[0]/g,1-f[1]/h,b/g,c/h];return this.boxs[a.color+""+Math.floor(a.w)]=i,i},KHPRender.prototype.drawText=function(a,b){var c=this.context;c.font=b.font;var d=parseInt(b.font)+4,e=c.measureText(a).width,f=this.getUV(e,d),c=this.context;c.fillStyle=b.color,c.textAlign=b.align,c.textBaseline=b.baseline,c.fillText(a,f[0],f[1]),this.updateUV(f,e);var g=[f[0]/this.canvasTexture.width,1-f[1]/this.canvasTexture.height,e/this.canvasTexture.width,d/this.canvasTexture.height];return g},KHPRender.prototype.drawSymbolLabels=function(a){var b=this.rowH,c=this.symbolW,d=a.departLocation,e=a.type1,f=a.type2,g=a.arrivalLocation,h=a.status,i=a.scheDepartTime,j=a.actualDepartTime,k=a.trainID,l=a.actualArrivalTime,m=a.scheArrivalTime,n="24px Arial",o="black",p=c,q=this.header,s={font:n,color:o,align:"left",baseline:"top"};return{box:this.drawBox({w:p,h:b,color:h,header:q,strokeColor:"black",fillColor:h}),departLoc:this.drawText(d,s),arrivalLoc:this.drawText(g,s),status:this.drawText(e+f,s),scheDepartTime:this.drawText(i,s),actualDepartTime:this.drawText(j,s),scheArrivalTime:this.drawText(m,s),actualArrivalTime:this.drawText(l,s),trainID:this.drawText(k,s)}},KHPRender.prototype.drawBoxLabels=function(a){var b=a.status,c=a.activity,d="24px Arial",e="black",g={font:d,color:e,align:"left",baseline:"top"};return{box:this.drawBox({w:a.width,h:this.rowH,color:b,header:this.header,strokeColor:"black",fillColor:b}),label:this.drawText(c,g)}},KHPRender.prototype.addGeometry=function(a,b,c){var d=[[a.position.x,a.position.y,a.position.z],[a.position.x+a.size[0],a.position.y-a.size[1],a.position.z],[a.position.x+a.size[0],a.position.y,a.position.z],[a.position.x,a.position.y-a.size[1],a.position.z]];b.push(d[0][0],d[0][1],d[0][2]),b.push(d[1][0],d[1][1],d[1][2]),b.push(d[2][0],d[2][1],d[2][2]),c.push(a.uv[0],a.uv[1]),c.push(a.uv[0]+a.uv[2],a.uv[1]-a.uv[3]),c.push(a.uv[0]+a.uv[2],a.uv[1]),b.push(d[3][0],d[3][1],d[3][2]),b.push(d[1][0],d[1][1],d[0][2]),b.push(d[0][0],d[0][1],d[0][2]),c.push(a.uv[0],a.uv[1]-a.uv[3]),c.push(a.uv[0]+a.uv[2],a.uv[1]-a.uv[3]),c.push(a.uv[0],a.uv[1])},KHPRender.prototype.addData=function(a,b){for(var c={departLocation:"DeL",type1:"A",type2:"L",arrivalLocation:"ArL",status:"white",scheDepartTime:"10:00",actualDepartTime:"10:05",trainID:"a12344",actualArrivalTime:"12:00",scheArrivalTime:"12:05",x:0},d=document.getElementById("graph-info"),f=(this.textures.length,a?a:100),g=b?b:100,h=0;h<f;h++){for(var i=0;i<g;i++){c.trainID=h+","+i,c.scheDepartTime="10:"+i,this.addSymbol(c,h);var j={status:"orange",activity:"Shop"};c.x+=this.symbolW,j.x=c.x,j.width=500,this.addTimeBox(j,h),c.x+=j.width}c.x=0}d.innerText="Box: "+f*g;var k=this,l=new THREE.TextureLoader,m=-window.innerWidth/2,n=window.innerHeight/2;l.load("loco.png",function(a){for(var b={position:{x:m,y:n,z:10},uv:[0,1,1,1],size:[128,k.rowH]},c=[],d=[],e=0;e<f;e++)k.addGeometry(b,c,d),b.position.y-=k.rowH+k.rowSpace;k.locos=k.createMesh(c,d,a)}),this.createMesh(this.boxPosition,this.boxUV,this.textureBox);for(var h=0;h<this.textures.length;h++)this.createMesh(this.meshPositions[h],this.meshUVs[h],this.textures[h])},KHPRender.prototype.createMesh=function(a,b,c){var d=new THREE.BufferGeometry;d.addAttribute("position",new THREE.BufferAttribute(new Float32Array(a),3).setDynamic(!0)),d.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(b),2).setDynamic(!0));var e=new THREE.MeshBasicMaterial({map:c,transparent:!0}),f=new THREE.Mesh(d,e);return c.needsUpdate=!0,this.scene.add(f),f},KHPRender.prototype.update=function(){this.locos.position.x=this.camera.position.x},LABEL_SIZE=5;